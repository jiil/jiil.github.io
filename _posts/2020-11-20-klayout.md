---
layout: post
title: klayout
---
``` ruby
# usage : klayout -e -rm genGds.rb

# usage : klayout -e -rm genGds.rb

module ORIS
  include RBA
  @@layout = RBA::Layout::new
  @@layer = @@layout.insert_layer(RBA::LayerInfo::new(4,0,"target"))

  def self.getLayout
    return @@layout
  end

  def self.getLayer
    return @@layer
  end

  def self.um_to_dbu(um)
    return (um / getLayout.dbu).round
  end

  def self.nm_to_dbu(nm)
    return (um_to_dbu(nm) / 1000).round
  end
  
  def self.dbu_to_um(dbu)
    return (dbu * getLayout.dbu)
  end

  def self.dbu_to_nm(dbu)
    return (dbu_to_um(dbu) * 1000).round
  end

  def self.getCell(name)
    return (getLayout.has_cell? name) ? getLayout.cell(name).cell_index : getLayout.add_cell(name)
  end

  def self.getName(prefix, a=nil, b=nil, c=nil, d=nil, e=nil, f=nil, g=nil)
    name = prefix 
    name += ( a ? "_" + dbu_to_nm(a).to_s : "")
    name += ( b ? "_" + dbu_to_nm(b).to_s : "")
    name += ( c ? "_" + dbu_to_nm(c).to_s : "")
    name += ( d ? "_" + dbu_to_nm(d).to_s : "")
    name += ( e ? "_" + dbu_to_nm(e).to_s : "")
    name += ( f ? "_" + dbu_to_nm(f).to_s : "")
    name += ( g ? "_" + dbu_to_nm(g).to_s : "")
    return name
  end

  def self.genLineCell(x_size, y_size)
    cell_idx = getLayout.add_cell(getName("box", x_size, y_size))
    getLayout.cell(cell_idx).shapes(getLayer).insert(RBA::Box::new(0, 0, x_size, y_size))
    return cell_idx
  end
  
  def self.getCellArray(cell_idx, posX, posY, pitchX = nil, pitchY = nil, countX = nil, countY = nil, angle=nil)
    t = RBA::DCplxTrans::new(posX, posY)
    if angle
      t.angle= angle
    end
    if pitchX && pitchY && countX && countY
      RBA::CellInstArray::new(cell_idx, t, RBA::Vector::new(pitchX, 0), RBA::Vector::new(0, pitchY), countX, countY)
    else
      RBA::CellInstArray::new(cell_idx, t)
    end
  end
  
  def self.genTwoBoxCell(x_size, y_size, gap_size, direction)
    cell_idx = getLayout.add_cell(getName("TB"+ direction, x_size, y_size, gap_size))
    lcell_idx = getLineCell(x_size, y_size)
    if direction == "X"
      ca = getCellArray(lcell_idx, 0, 0, x_size + gap_size, y_size, 2, 1)
    else
      ca = getCellArray(lcell_idx, 0, 0, x_size , y_size + gap_size, 1, 2)
    end
    getLayout.cell(cell_idx).insert(ca)
    return cell_idx
  end

  def self.getLineCell(x_size, y_size)
    name = getName("box", x_size, y_size)
    return (getLayout.has_cell? name) ? getLayout.cell(name).cell_index : genLineCell(x_size, y_size)
  end

  def self.getTwoBoxCell(x_size, y_size, gap_size, direction)
    name = getName("TB" + direction, x_size, y_size, gap_size)
    return (getLayout.has_cell? name) ? getLayout.cell(name).cell_index 
    : genTwoBoxCell(x_size, y_size, gap_size, direction)
  end

  def self.getCellArrayAdjust(cell_idx, padX, padY, width, height, posX, posY)
    bbox = getLayout.cell(cell_idx).bbox_per_layer(getLayer)

    pitchX = bbox.right + padX
    pitchY = bbox.top + padY
    
    gapX =  posX % pitchX 
    gapY =  posY % pitchY 
    startPosX = (gapX < bbox.right/2) ? posX-gapX : posX +  pitchX - gapX
    startPosY = (gapY < bbox.top/2) ? posY-gapY : posY +  pitchY - gapY
    endPosX = posX + width
    endPosY = posY + height
    countX = (endPosX % pitchX < bbox.right/2 )? (endPosX-startPosX)/ pitchX : (endPosX-startPosX) / pitchX + 1
    countY = (endPosY % pitchY < bbox.top/2 )? (endPosY-startPosY) / pitchY  : (endPosY-startPosY)/ pitchY + 1

    getCellArray(cell_idx, startPosX, startPosY, pitchX, pitchY, countX, countY)
  end

  def self.getLable(cell_idx, name, posX, posY)
      lib = RBA::Library.library_by_name("Basic")
      pcell_decl = lib.layout.pcell_declaration("TEXT")
      param = {"text" => name, "layer" => getLayout.get_info(getLayer), "mag" => 1}
      pv = pcell_decl.get_parameters.collect do |p|
        param[p.name] || p.default
      end
      pcell_var = getLayout.add_pcell_variant(lib, pcell_decl.id, pv)
      t = RBA::Trans::new(posX,posY)
      getLayout.cell(cell_idx).insert(RBA::CellInstArray::new(pcell_var, t))
  end

  def self.genAxisLineframe(pattern_size, space_size, direction)
    # outer 20um * 20um 
    # boder 4um
    # mark space 4um * 8um 
    frame_idx = getCell(getName("AxisLine" + direction, pattern_size, space_size))
    cell = getLayout.cell(frame_idx)

    # gen 2um * 2um  axis line box cell 
    if direction == "X"
      line_idx = getLineCell(um_to_dbu(2), pattern_size, )
      padX = 0
      padY = space_size
    else
      line_idx = getLineCell(pattern_size, um_to_dbu(2), )
      padX = space_size
      padY = 0
    end
    # TOP 20um * 4um (base: 0,16)
    # MID 4um * 12um *2 (base: (0,4), (16,4))
    # BOTTOM 6um * 4um * 2 (base: (0,0), (14,0))
    cell.insert(getCellArrayAdjust(line_idx, padX, padY, um_to_dbu(20), um_to_dbu(4), um_to_dbu(0), um_to_dbu(16)))
    cell.insert(getCellArrayAdjust(line_idx, padX, padY, um_to_dbu(4), um_to_dbu(12), um_to_dbu(0), um_to_dbu(4)))
    cell.insert(getCellArrayAdjust(line_idx, padX, padY, um_to_dbu(4), um_to_dbu(12), um_to_dbu(16), um_to_dbu(4)))
    cell.insert(getCellArrayAdjust(line_idx, padX, padY, um_to_dbu(6), um_to_dbu(4), um_to_dbu(0), um_to_dbu(0)))
    cell.insert(getCellArrayAdjust(line_idx, padX, padY, um_to_dbu(6), um_to_dbu(4), um_to_dbu(14), um_to_dbu(0)))

    # add frame tag 
    getLable(frame_idx, "FP" + dbu_to_nm(pattern_size).to_s + "_S" + dbu_to_nm(space_size).to_s + "_" + direction , um_to_dbu(6.5), um_to_dbu(0))
    return frame_idx
  end

  def self.genLSPattern(pattern_size, space_size, direction)
    # outer 10um * 10um 
    fcell_idx = getCell(getName("PTN_LS"+ direction, pattern_size, space_size))
    cell = getLayout.cell(fcell_idx)

    # gen 10um * 10um  axis line box cell 
    if direction == "X"
      lcell_idx = getLineCell(um_to_dbu(10), pattern_size)
      pitchX = um_to_dbu(10)
      pitchY = pattern_size + space_size
    else
      lcell_idx = getLineCell(pattern_size, um_to_dbu(10))
      pitchX = pattern_size + space_size
      pitchY = um_to_dbu(10)
    end
    cell.insert(getCellArray(lcell_idx, um_to_dbu(5), um_to_dbu(5), pitchX, pitchY, um_to_dbu(10)/pitchX, um_to_dbu(10)/pitchY))
    getLable(fcell_idx, "RP" + dbu_to_nm(pattern_size).to_s + "_S" + dbu_to_nm(space_size).to_s + "_" + direction , um_to_dbu(6.5), um_to_dbu(1))
    return fcell_idx
  end

  def self.genT2TPattern(pattern_size, space_size, gap_size, direction)
    # outer 10um * 10um 
    fcell_idx = getCell(getName("PTN_T2T"+ direction, pattern_size, space_size))
    cell = getLayout.cell(fcell_idx)

    # gen 10um * 10um  axis line box cell 
    if direction == "X"
      lcell_idx = getTwoBoxCell(um_to_dbu(5)-nm_to_dbu(gap_size/2), pattern_size, gap_size, direction)
      pitchX = um_to_dbu(10)
      pitchY = pattern_size + space_size
    else
      lcell_idx = getTwoBoxCell(pattern_size, um_to_dbu(5)-nm_to_dbu(gap_size/2), gap_size, direction)
      pitchX = pattern_size + space_size
      pitchY = um_to_dbu(10)
    end
    cell.insert(getCellArray(lcell_idx, um_to_dbu(5), um_to_dbu(5), pitchX, pitchY, um_to_dbu(10)/pitchX, um_to_dbu(10)/pitchY))
    getLable(fcell_idx, "RP" + dbu_to_nm(pattern_size).to_s + "_S" + dbu_to_nm(space_size).to_s + "_" + direction , um_to_dbu(6.5), um_to_dbu(1))
    return fcell_idx
  end

  def self.genDiaPattern(pattern_size, space_size, angle)
    # outer 10um * 10um 
    fcell_idx = getCell(getName("PTN_DIA"+ angle.to_s, pattern_size, space_size))
    cell = getLayout.cell(fcell_idx)

    # gen 10um * 10um  axis line box cell 
    lcell_idx = getLineCell(um_to_dbu(1), pattern_size)
    pitchX = (Math::cos(angle)*um_to_dbu(1)).round.abs
    #pitchY = (Math::sin(angle) *(pattern_size + space_size)).round
    pitchY = (Math::sin(angle) *um_to_dbu(1)).round.abs
    cell.insert(getCellArray(lcell_idx, um_to_dbu(5), um_to_dbu(5), pitchX, pitchY, um_to_dbu(10)/pitchX, um_to_dbu(10)/pitchY, angle))
    getLable(fcell_idx, "RP" + dbu_to_nm(pattern_size).to_s + "_S" + dbu_to_nm(space_size).to_s + "_" + angle.to_s , um_to_dbu(6.5), um_to_dbu(1))
    return fcell_idx
  end

  def self.genTemplate(cell_idx, frame_pattern_size, frame_space_size, frame_direction, pattern_size, space_size, gap_size, direction, posX, posY, type = "LS")
    layout = getLayout
    if type == "LS"
      frame = genAxisLineframe(frame_pattern_size, frame_space_size, frame_direction)
      real = genLSPattern(pattern_size, space_size, direction)
      t = RBA::Trans::new(posX,posY)
      layout.cell(cell_idx).insert(RBA::CellInstArray::new(frame, t))
      layout.cell(cell_idx).insert(RBA::CellInstArray::new(real, t))

      name = "F" + frame_direction + "_" + dbu_to_nm(frame_pattern_size).to_s + "_" + dbu_to_nm(frame_space_size).to_s \
            + "R" + direction + "_" + dbu_to_nm(pattern_size).to_s + "_" + dbu_to_nm(space_size).to_s 
      if direction == "X"
        gauge = (posX + um_to_dbu(10)).to_s + " " + (posY + um_to_dbu(10) - 10 ).to_s  + " " + (posX + um_to_dbu(10)).to_s + " " + (posY + um_to_dbu(10) + 10).to_s
      else
        gauge = (posX + um_to_dbu(10) - 10 ).to_s + " " + (posY + um_to_dbu(10)).to_s  + " " + (posX + um_to_dbu(10) + 10).to_s + " " + (posY + um_to_dbu(10)).to_s
      end
      return "1 "+ name + " 1 1 " + gauge + " 0 0 0 0 0 0 0 0 0 0 0 NA NA" 
    elsif type == "T2T"
      frame = genAxisLineframe(frame_pattern_size, frame_space_size, frame_direction )
      real = genT2TPattern(pattern_size, space_size, gap_size, direction )
      t = RBA::Trans::new(posX,posY)
      layout.cell(cell_idx).insert(RBA::CellInstArray::new(frame, t))
      layout.cell(cell_idx).insert(RBA::CellInstArray::new(real, t))

      name = "F" + frame_direction + "_" + dbu_to_nm(frame_pattern_size).to_s + "_" + dbu_to_nm(frame_space_size).to_s \
            + "R" + direction + "_" + dbu_to_nm(pattern_size).to_s + "_" + dbu_to_nm(space_size).to_s 
      if direction == "X"
        gauge = (posX + um_to_dbu(10) - 10 ).to_s + " " + (posY + um_to_dbu(10)).to_s  + " " + (posX + um_to_dbu(10) + 10).to_s + " " + (posY + um_to_dbu(10)).to_s
      else
        gauge = (posX + um_to_dbu(10)).to_s + " " + (posY + um_to_dbu(10) - 10 ).to_s  + " " + (posX + um_to_dbu(10)).to_s + " " + (posY + um_to_dbu(10) + 10).to_s
      end
      return "1 "+ name + " 1 1 " + gauge + " 0 0 0 0 0 0 0 0 0 0 0 NA NA" 
    elsif type == "DIA"
      frame = genAxisLineframe(frame_pattern_size, frame_space_size, frame_direction )
      real = genDiaPattern(pattern_size, space_size, direction)
      t = RBA::Trans::new(posX,posY)
      layout.cell(cell_idx).insert(RBA::CellInstArray::new(frame, t))
      layout.cell(cell_idx).insert(RBA::CellInstArray::new(real, t))

      name = "F" + frame_direction + "_" + dbu_to_nm(frame_pattern_size).to_s + "_" + dbu_to_nm(frame_space_size).to_s \
        + "R" + direction.to_s + "_" + dbu_to_nm(pattern_size).to_s + "_" + dbu_to_nm(space_size).to_s 
        gauge = (posX + um_to_dbu(10) - 10 ).to_s + " " + (posY + um_to_dbu(10)).to_s  + " " + (posX + um_to_dbu(10) + 10).to_s + " " + (posY + um_to_dbu(10)).to_s
      return "1 "+ name + " 1 1 " + gauge + " 0 0 0 0 0 0 0 0 0 0 0 NA NA" 
    end
  end

  getLayout.dbu = 0.0005 

  cell_idx = getCell("SCORE") 
  pitch = um_to_dbu(21)
  ggString = ""

  for i in 0 ..99
    frame_size = nm_to_dbu(150-i)
    pattern_size = nm_to_dbu(15+i)
    ggString += genTemplate(cell_idx, frame_size, frame_size, "X", pattern_size, pattern_size, pattern_size, "Y", pitch * i, 0, "LS") + "\n"
    ggString += genTemplate(cell_idx, frame_size, frame_size, "Y", pattern_size, pattern_size, pattern_size, "X", pitch * i, pitch, "LS") + "\n"
    ggString += genTemplate(cell_idx, frame_size, frame_size, "X", pattern_size, pattern_size, pattern_size, "X", pitch * i, pitch *2, "LS") + "\n"
    ggString += genTemplate(cell_idx, frame_size, frame_size, "Y", pattern_size, pattern_size, pattern_size, "Y", pitch * i, pitch *3, "LS") + "\n"
    ggString += genTemplate(cell_idx, frame_size, frame_size, "X", pattern_size, pattern_size, pattern_size, "Y", pitch * i, pitch *4, "T2T") + "\n"
    ggString += genTemplate(cell_idx, frame_size, frame_size, "Y", pattern_size, pattern_size, pattern_size, "X", pitch * i, pitch *5, "T2T") + "\n"
    ggString += genTemplate(cell_idx, frame_size, frame_size, "Y", pattern_size, pattern_size, pattern_size, 30, pitch * i, pitch *6, "DIA") + "\n"
  end

  File.write("regression.gg", ggString)

  getLayout.write("regression.oas")
end



```
