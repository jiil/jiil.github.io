---
layout: post
title: klayout
---
``` ruby
module ORIS
  include RBA

  def self.getLayout
    cv = RBA::Application::instance.main_window.current_view
    return cv ? cv.active_cellview.layout 
    : RBA::Application::instance.main_window.create_layout(1).layout
  end

  def self.nm_to_dbu(nm)
    layout = getLayout
    return ((nm / layout.dbu)/1000).round
  end
  
  def self.um_to_dbu(um)
    layout = getLayout
    return (um / layout.dbu).round
  end

  def self.dbu_to_nm(dbu)
    layout = getLayout
    return (dbu * 1000 * layout.dbu).round
  end
  
  def self.getLayer(ln, dt, name = nil)
    layout = getLayout
    return layout.find_layer(ln, dt) || layout.insert_layer(RBA::LayerInfo::new(ln, dt, name))
  end

  def self.genLineCell(x_size, y_size, layer_idx)
    layout = getLayout
    name = "box_" + dbu_to_nm(x_size).to_s + "_" + dbu_to_nm(y_size).to_s
    box = RBA::Box::new(0, 0, x_size, y_size)
    cell_idx = layout.add_cell(name)
    layout.cell(cell_idx).shapes(layer_idx).insert(box)
    return cell_idx
  end
  
  def self.getLineCell(x_size, y_size, layer_idx)
    layout = getLayout
    name = "box_" + dbu_to_nm(x_size).to_s + "_" + dbu_to_nm(y_size).to_s
    return (layout.has_cell? name) ? layout.cell(name).cell_index 
    : genLineCell(x_size, y_size, layer_idx)
  end

  def self.getCell(name)
    layout = getLayout
    return (layout.has_cell? name) ? layout.cell(name).cell_index 
    : layout.add_cell(name)
  end

  def self.getFrameCell(prefix, x_size, y_size, direction)
    name = prefix + "_" + dbu_to_nm(x_size).to_s + "_" + dbu_to_nm(y_size).to_s + "_" + direction
    getCell(name)
  end
  
  def self.getCellArray(cell_idx, posX, posY, pitchX = nil, pitchY = nil, countX = nil, countY = nil)
    t = RBA::Trans::new(posX, posY)
    if pitchX && pitchY && countX && countY
      v1 = RBA::Vector::new(pitchX, 0)
      v2 = RBA::Vector::new(0, pitchY)
      RBA::CellInstArray::new(cell_idx, t, v1, v2, countX, countY)
    else
      RBA::CellInstArray::new(cell_idx, t)
    end
  end
  
  def self.getCellArrayAdjust(cell_idx, layer_idx, padX, padY, width, height, posX, posY)
    layout = getLayout
    bbox = layout.cell(cell_idx).bbox_per_layer(layer_idx)

    pitchX = bbox.right + padX
    pitchY = bbox.top + padY
    
    gapX =  posX % pitchX 
    gapY =  posY % pitchY 
    startPosX = (gapX < bbox.right/2) ? posX-gapX : posX +  pitchX - gapX
    startPosY = (gapY < bbox.top/2) ? posY-gapY : posY +  pitchY - gapY
    endPosX = posX + width
    endPosY = posY + height
    countX = (endPosX % pitchX < bbox.right/2 )? (endPosX-startPosX)/ pitchX : (endPosX-startPosX) / pitchX + 1
    countY = (endPosY % pitchY < bbox.top/2 )? (endPosY-startPosY) / pitchY  : (endPosY-startPosY)/ pitchY + 1

    getCellArray(cell_idx, startPosX, startPosY, pitchX, pitchY, countX, countY)
  end

  def self.getLable(frame_idx, layer_idx, name, posX, posY)
      layout = getLayout
      lib = RBA::Library.library_by_name("Basic")
      pcell_decl = lib.layout.pcell_declaration("TEXT")
      param = {"text" => name, "layer" => layout.get_info(layer_idx), "mag" => 1}
      pv = pcell_decl.get_parameters.collect do |p|
        param[p.name] || p.default
      end
      pcell_var = layout.add_pcell_variant(lib, pcell_decl.id, pv)
      t = RBA::Trans::new(posX,posY)
      layout.cell(frame_idx).insert(RBA::CellInstArray::new(pcell_var, t))
  end

  def self.genAxisLineframe(pattern_size, space_size, direction, layer_idx)
    # outer 20um * 20um 
    # boder 4um
    # mark space 4um * 8um 
    frame_idx = getFrameCell("AxisLine", pattern_size, space_size, direction)
    cell = getLayout.cell(frame_idx)

    # gen 2um * 2um  axis line box cell 
    if direction == "X"
      line_idx = getLineCell(um_to_dbu(2), pattern_size, layer_idx)
      padX = 0
      padY = space_size
    else
      line_idx = getLineCell(pattern_size, um_to_dbu(2), layer_idx)
      padX = space_size
      padY = 0
    end
    # TOP 20um * 4um (base: 0,16)
    # MID 4um * 12um *2 (base: (0,4), (16,4))
    # BOTTOM 6um * 4um * 2 (base: (0,0), (14,0))
    cell.insert(getCellArrayAdjust(line_idx, layer_idx, padX, padY, um_to_dbu(20), um_to_dbu(4), um_to_dbu(0), um_to_dbu(16)))
    cell.insert(getCellArrayAdjust(line_idx, layer_idx, padX, padY, um_to_dbu(4), um_to_dbu(12), um_to_dbu(0), um_to_dbu(4)))
    cell.insert(getCellArrayAdjust(line_idx, layer_idx, padX, padY, um_to_dbu(4), um_to_dbu(12), um_to_dbu(16), um_to_dbu(4)))
    cell.insert(getCellArrayAdjust(line_idx, layer_idx, padX, padY, um_to_dbu(6), um_to_dbu(4), um_to_dbu(0), um_to_dbu(0)))
    cell.insert(getCellArrayAdjust(line_idx, layer_idx, padX, padY, um_to_dbu(6), um_to_dbu(4), um_to_dbu(14), um_to_dbu(0)))

    # add frame tag 
    getLable(frame_idx, layer_idx, "FP" + dbu_to_nm(pattern_size).to_s + "_S" + dbu_to_nm(space_size).to_s + "_" + direction , 6500, 0)
    return frame_idx
  end

  def self.genLSPattern(pattern_size, space_size, direction, layer_idx)
    # outer 10um * 10um 
    fcell_idx = getFrameCell("PTN_LS", pattern_size, space_size, direction)
    cell = getLayout.cell(fcell_idx)

    # gen 10um * 10um  axis line box cell 
    if direction == "X"
      lcell_idx = getLineCell(um_to_dbu(10), pattern_size, layer_idx)
      pitchX = um_to_dbu(10)
      pitchY = pattern_size + space_size
    else
      lcell_idx = getLineCell(pattern_size, um_to_dbu(10), layer_idx)
      pitchX = pattern_size + space_size
      pitchY = um_to_dbu(10)
    end
    puts(um_to_dbu(10))
    cell.insert(getCellArray(lcell_idx, um_to_dbu(5), um_to_dbu(5), pitchX, pitchY, um_to_dbu(10)/pitchX, um_to_dbu(10)/pitchY))
    getLable(fcell_idx, layer_idx, "RP" + dbu_to_nm(pattern_size).to_s + "_S" + dbu_to_nm(space_size).to_s + "_" + direction , um_to_dbu(6.5), um_to_dbu(1))
    return fcell_idx
  end

  layout = getLayout
  layer_idx = getLayer(93,0)
  cell_idx = getCell("SCORE")
  frame = genAxisLineframe(nm_to_dbu(18), nm_to_dbu(20), "Y", layer_idx)
  real = genLSPattern(nm_to_dbu(180), nm_to_dbu(200), "X", layer_idx)
  t = RBA::Trans::new(0,0)
  layout.cell(cell_idx).insert(RBA::CellInstArray::new(frame, t))
  layout.cell(cell_idx).insert(RBA::CellInstArray::new(real, t))
  lv = RBA::Application::instance.main_window.current_view
  lv.select_cell(cell_idx, 0)
  lv.add_missing_layers
  lprop = lv.begin_layers.current
  lprop.fill_color= 0xff0000
  lprop.frame_color = 0xff0000
  lv.zoom_fit
end



```
