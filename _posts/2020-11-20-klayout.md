---
layout: post
title: klayout
---
``` ruby
module ORIS
  include RBA

  def self.getLayout
    cv = RBA::Application::instance.main_window.current_view
    if cv == nil
      return RBA::Application::instance.main_window.create_layout(1).layout
    else
      return cv.active_cellview.layout
    end
  end

  def self.nm_to_dbu(nm)
    layout = getLayout
    return (nm * layout.dbu() * 1000).round
  end

  def self.getLayer(ln, dt, name = nil)
    layout = getLayout
    layer_idx = layout.find_layer(ln, dt)
    if layer_idx == nil
      if name == nil
        layer_idx = layout.insert_layer(RBA::LayerInfo::new(ln,dt))
      else
        layer_idx = layout.insert_layer(RBA::LayerInfo::new(ln,dt, name))
      end
    end
    return layer_idx
  end

  def self.getLineCell(nXSize, nYSize, layer_idx)
    layout = getLayout
    name = "box_" + nXSize.to_s + "_" + nYSize.to_s

    if layout.has_cell? name
      cell_idx = layout.cell(name).cell_index
    else
      cell_idx = layout.add_cell(name)
      box = RBA::Box::new(0, 0, nm_to_dbu(nXSize), nm_to_dbu(nYSize))
      layout.cell(cell_idx).shapes(layer_idx).insert(box)
    end
    return cell_idx
  end

  def self.getCell(name)
    layout = getLayout
    if layout.has_cell? name
      cell_idx = layout.cell(name).cell_index
    else
      cell_idx = layout.add_cell(name)
    end
    return cell_idx
  end

  def self.getFrameCell(prefix, nXSize, nYSize, direction)
    name = prefix + "_" + nXSize.to_s + "_" + nYSize.to_s + "_" + direction
    getCell(name)
  end

  def self.getPatternBoxInst(cell_idx, line_idx, layer_idx, nSpace, direction, nWidth, nHeight, nStartX, nStartY)
    layout = getLayout
    bbox = layout.cell(line_idx).bbox_per_layer(layer_idx)

    if direction == "X"
      x = bbox.right
      y = bbox.top + nm_to_dbu(nSpace)
    else
      x = bbox.right + nm_to_dbu(nSpace)
      y = bbox.top
    end
    gapX = (x - nm_to_dbu(nStartX) %x) %x
    gapY = (y - nm_to_dbu(nStartY) %y) %y

    t = RBA::Trans::new(nm_to_dbu(nStartX)+gapX, nm_to_dbu(nStartY) + gapY)
    v1 = RBA::Vector::new(x, 0)
    v2 = RBA::Vector::new(0, y)
    ca = RBA::CellInstArray::new(line_idx, t, v1, v2, (nm_to_dbu(nWidth)-gapX)/x, (nm_to_dbu(nHeight)-gapY)/y)
    layout.cell(cell_idx).insert(ca)
  end

  def self.getLable(frame_idx, layer_idx, name, nStartX, nStartY)
      layout = getLayout
      lib = RBA::Library.library_by_name("Basic")
      pcell_decl = lib.layout.pcell_declaration("TEXT")
      param = {"text" => name, "layer" => layout.get_info(layer_idx), "mag" => 1}
      pv = pcell_decl.get_parameters.collect do |p|
        param[p.name] || p.default
      end

      pcell_var = layout.add_pcell_variant(lib, pcell_decl.id, pv)
      t = RBA::Trans::new(nm_to_dbu(nStartX),nm_to_dbu(nStartY))
      layout.cell(frame_idx).insert(RBA::CellInstArray::new(pcell_var, t))
  end

  def self.genAxisLineframe(nPattern, nSpace, direction, layer_idx)
    # outer 20um * 20um 
    # boder 4um
    # mark space 4um * 8um 
    frame_idx = getFrameCell("AxisLine", nPattern, nSpace, direction)

    # gen 2um * 2um  axis line box cell 
    if direction == "X"
      line_idx = getLineCell(2000, nPattern, layer_idx)
    else
      line_idx = getLineCell(nPattern, 2000, layer_idx)
    end
    # TOP 20um * 4um (base: 0,16)
    # MID 4um * 12um *2 (base: (0,4), (16,4))
    # BOTTOM 6um * 4um * 2 (base: (0,0), (14,0))
    getPatternBoxInst(frame_idx, line_idx, layer_idx, nSpace, direction, 20000, 4000, 0, 16000)
    getPatternBoxInst(frame_idx, line_idx, layer_idx, nSpace, direction, 4000, 12000, 0, 4000)
    getPatternBoxInst(frame_idx, line_idx, layer_idx, nSpace, direction, 4000, 12000, 16000, 4000)
    getPatternBoxInst(frame_idx, line_idx, layer_idx, nSpace, direction, 6000, 4000, 0, 0)
    getPatternBoxInst(frame_idx, line_idx, layer_idx, nSpace, direction, 6000, 4000, 14000, 0)

    # add frame tag 
    getLable(frame_idx, layer_idx, "FP" + nPattern.to_s + "_S" + nSpace.to_s + "_" + direction , 6500, 0)
    return frame_idx
  end

  def self.genLSPattern(nPattern, nSpace, direction, layer_idx)
    # outer 10um * 10um 
    frame_idx = getFrameCell("PTN_LS", nPattern, nSpace, direction)

    # gen 10um * 10um  axis line box cell 
    if direction == "X"
      line_idx = getLineCell(5000, nPattern, layer_idx)
    else
      line_idx = getLineCell(nPattern, 5000, layer_idx)
    end
    getPatternBoxInst(frame_idx, line_idx, layer_idx, nSpace, direction, 10000, 10000, 5000, 5000)
    getLable(frame_idx, layer_idx, "RP" + nPattern.to_s + "_S" + nSpace.to_s + "_" + direction , 6500, 1000)
    return frame_idx
  end

  layout = getLayout
  layer_idx = getLayer(93,0, "target")
  cell_idx = getCell("SCORE")
  frame = genAxisLineframe(180, 200, "X", layer_idx)
  real = genLSPattern(180, 200, "Y", layer_idx)
  t = RBA::Trans::new(0,0)
  layout.cell(cell_idx).insert(RBA::CellInstArray::new(frame, t))
  layout.cell(cell_idx).insert(RBA::CellInstArray::new(real, t))
  lv = RBA::Application::instance.main_window.current_view
  lv.select_cell(cell_idx, 0)
  lv.add_missing_layers
  lprop = lv.begin_layers.current
  lprop.fill_color= 0xff0000
  lprop.frame_color = 0xff0000
  lv.zoom_fit
end

```
